https://www.youtube.com/watch?v=_F6k0tg8ODo

# 채팅 메시지 전달
![[Pasted image 20251025150419.png|300]]
A가 메시지를 B에게 전달해달라는 이벤트 발행
![[Pasted image 20251025150445.png|300]]
Consumer가 이벤트를 가져와서 Key-Value 저장소에서 B가 어떤 서버와 연결되어 있는지를 확인 후 Server 2에 메시지 전달
![[Pasted image 20251025150723.png|300]]
Push 요청을 보내는 상황은 Key-Value store에 User B가 접속중이지 않다고 생각할 때 보낸다.
![[Pasted image 20251025150813.png|300]]
Key-Value Store가 잘못된 데이터를 가지고 있다면, Server 2가 Consumer에 의해 데이터를 받더라도 로컬 메모리에 세션 정보가 없기 때문에 데이터가 잘못되었구나를 인지하고 Push Server에 데이터를 보냄
그 후 Key-Value Store에게 데이터 삭제 요청을 보냄

이처럼 key-value store는 신뢰하면 안됨

### 그룹 채팅
![[Pasted image 20251025151417.png|300]]
하지만, 이 시나리오는 그룹 내에 인원이 많을 때 보내는 횟수가 계속 늘어날 수 있다는 점이 좋지 않음

![[Pasted image 20251025151438.png|300]]
유저 아이디를 묶어서 보내면 단점을 해결할 수 있음
Consumer가 누가 어느 서버에 존재하는지 확인하고 정리해서 Server에 데이터를 보낼 수 있게 됨
하지만, 한 번에 너무 많은 작업을 처리하면 시간이 오래 걸려 Timeout 구분이 어려워지게 된다.
![[Pasted image 20251025151606.png|300]]
유저 아이디를 200개씩의 chunk 단위로 나누어 처리할 수 있다.
# 채팅 메시지 저장

