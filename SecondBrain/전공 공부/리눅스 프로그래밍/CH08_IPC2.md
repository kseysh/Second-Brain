# **POSIX:XSI Message Queue**
### IPC (프로세스 간 통신)

- POSIX의 XSI 확장에 포함된 IPC 함수들은 **System V IPC** 함수에 기초하여 개발되었습니다.
- **같은 시스템 내에서 프로세스 간 정보를 공유할 수 있는 메커니즘**을 제공합니다.

### 권한 구조

- IPC 객체가 생성될 때, 시스템은 IPC 시설 상태 구조도 함께 생성합니다.
- 접근 권한은 **유효 사용자 ID와 그룹 ID**에 의해 결정됩니다.
- IPC 시설이 생성될 때 `umask` 값은 적용되지 않습니다.
- `msgctl`, `semctl`, 또는 `shmctl` 호출을 통해 `uid`, `gid`, `mode` 필드를 수정할 수 있습니다. 단, **생성자**나 **슈퍼유저**만 가능합니다.

### 식별자와 키

- **키 (Key)**:
  - IPC 객체의 외부 이름 역할을 합니다.
  - IPC 구조가 생성될 때마다(`msgget`, `semget`, `shmget` 호출) 키가 지정되어야 합니다.
  - 데이터 타입은 `key_t`이며, `<sys/types.h>`에 정의된 **long integer** 타입입니다.

- **식별자 (Identifier)**:
  - IPC 객체의 내부 이름이며, **음수가 아닌 정수**입니다.
  - `get` 작업의 결과로 반환됩니다.
  - **파일 디스크립터와 비슷하게 작동**하지만, IPC 식별자는 고유합니다. 즉, 다른 프로세스가 동일 IPC 객체를 참조할 때도 동일한 값을 사용합니다.

### `ftok(2)` 시스템 호출

- **경로**와 **ID**를 **IPC 키(key_t)** 값으로 변환하는 함수입니다.
- 매개변수:
  - `path`: 기존 파일이어야 합니다.
  - `id`: **하위 8비트**만 사용됩니다.
- `path`와 `id`의 조합으로 **IPC 객체를 고유하게 식별**할 수 있습니다.
- `path`가 존재하지 않거나 호출 프로세스에서 접근할 수 없으면 `ftok`는 **-1을 반환**합니다.

### 세 가지 XXXget 함수

- **IPC 객체를 생성하거나 여는 함수**이며 모두 IPC 키를 사용합니다.

- **키 선택 방법**:
  1. 시스템이 키를 선택하게 함 (`IPC_PRIVATE` 사용).
  2. 직접 키를 지정함.
  3. `ftok`를 호출하여 지정된 경로로부터 키를 생성함.

- **권한 플래그**:
  - `IPC_CREAT`는 `O_CREAT`와 유사합니다.
  - `IPC_EXCL`는 `O_EXCL`와 유사합니다.

### IPC get 연산 (2/2)

- IPC 구조에 대해 **실행 권한에 해당하는 것이 없습니다**.
- 메시지 큐와 공유 메모리는 **읽기(read)와 쓰기(write)**라는 용어를 사용하지만, **세마포어는 읽기(read)와 변경(alter)**이라는 용어를 사용합니다.

### IPC 제어 연산

- IPC 리소스를 처리하기 위해 사용할 수 있는 함수들입니다.

### IPC 키에서 IPC 식별자 생성하기

- **IPC 키로부터 IPC 식별자를 생성**하여 사용합니다.

### 셸에서 IPC 리소스 접근하기

- IPC 리소스는 **셸을 통해서도 접근할 수 있습니다**.

### 메시지 큐 (1/2)

- **메시지 큐**는 POSIX:XSI 프로세스 간 통신 메커니즘으로, 프로세스가 다른 프로세스로부터 메시지를 송수신할 수 있도록 합니다.
- 커널 내에 저장된 메시지의 **연결 리스트**로, 메시지 큐 식별자에 의해 식별됩니다.

### `msgget(2)` 시스템 호출

- `msgget` 함수는 **키 매개변수에 연관된 메시지 큐 식별자**를 반환합니다.

### `msgsnd(2)` 시스템 호출

- `msgsnd`를 사용하여 **메시지를 큐에 삽입**합니다.
- 메시지는 항상 큐의 끝에 추가됩니다.
- 매개변수:
  - `ptr`: 사용자 정의 버퍼를 가리킵니다.
  - `nbytes`: 메시지 크기
  - `flag`: `IPC_NOWAIT`가 지정되지 않은 경우, 메시지를 위한 공간이 생길 때까지 **대기**합니다.

### `msgrcv(2)` 시스템 호출

- 매개변수:
  - `ptr`: 사용자 정의 버퍼를 가리킵니다.
  - `nbytes`: 메시지 크기
  - `type` 행동:
    - `== 0`: 큐의 첫 번째 메시지 제거
    - `> 0`: 큐에서 특정 `type`의 첫 번째 메시지 제거
    - `< 0`: 절대값 이하의 가장 낮은 `type`의 첫 번째 메시지 제거
  - `flag`: `IPC_NOWAIT`, `MSG_NOERROR`
- 반환된 메시지가 `nbytes`보다 크고 `MSG_NOERROR`가 설정되어 있으면, 메시지가 잘립니다. 이 플래그가 없으면 **E2BIG 오류**가 반환됩니다.

### `msgctl(2)` 시스템 호출

- `msgctl`은 **메시지 큐를 제거하거나 권한을 변경**할 때 사용됩니다.

### 우선순위가 있는 메시지 큐 예제 (1)

---

### POSIX:XSI 세마포어

- **세마포어**는 여러 프로세스가 **공유 데이터 객체에 접근할 수 있도록** 하기 위한 카운터입니다.
- 1965년 E. W. Dijkstra가 상호 배제와 동기화를 관리하기 위해 제안한 추상 개념입니다.
- **wait (down, P, lock)**와 **signal (up, V, unlock, post)** 두 가지 원자적 작업을 포함하는 **정수 변수**입니다.

### POSIX:XSI 세마포어 (1/3)

- POSIX:XSI 세마포어는 **세마포어 요소 배열**로 구성됩니다.
- 프로세스는 단일 호출로 전체 세트를 조작할 수 있습니다.
- 각 세마포어 요소는 다음 정보를 포함합니다(`struct sem`):
  - `semval`: 세마포어 값 (0 이상)
  - `sempid`: 마지막으로 세마포어를 조작한 프로세스 ID
  - `semncnt`: 세마포어 값이 증가하기를 기다리는 프로세스 수
  - `semzcnt`: 세마포어 값이 0이 되기를 기다리는 프로세스 수
- 세마포어 값이 0이 되면 큐에 있는 프로세스가 깨워집니다.
- 각 세마포어 요소는 두 가지 큐를 가집니다:
  - 값 증가 대기 프로세스 큐
  - 값이 0이 되기를 기다리는 프로세스 큐

### `semget(2)` 시스템 호출 (1/2)

- 키에 연관된 세마포어 식별자를 반환합니다.
- 매개변수:
  - `nsems`: 세트 내 세마포어 요소 수 (`nsems == 0`일 경우 기존 세트를 참조)

### `semctl(2)` 시스템 호출 (1/2)

- 세마포어 세트의 각 요소는 사용 전에 **`semctl`로 초기화**되어야 합니다.
- 매개변수:
  - `arg`: `cmd`의 값에 따라 달라집니다.

### `semop(2)` 시스템 호출 (1/2)

- `semop`는 사용자 정의 세마포어 작업을 **세마포어 세트에 대해 원자적으로 수행**합니다.

### `semop(2): SEM_UNDO` (1/4)

- XSI IPC 객체는 **어떤 프로세스도 사용하지 않을 때도 존재**하기 때문에, 프로그램이 할당받은 세마포어를 해제하지 않고 종료하는 경우에 대비해야 합니다.
- `SEM_UNDO` 플래그를 사용하여 프로세스가 종료될 때 세마포어 조정을 **자동으로 수행**할 수 있습니다.

### POSIX:XSI 공유 메모리

- **공유 메모리**는 여러 프로세스가 **같은 메모리 세그먼트를 읽고 쓸 수 있도록** 합니다.
- 데이터가 클라이언트와 서버 사이에서 복사될 필요가 없기 때문에 **가장 빠른 IPC 방식**입니다.
- 서버가 공유 메모리 영역에 데이터를 기록할 때 **클라이언트는 서버가 완료될 때까지 접근을 지양**해야 합니다.
  - 종종 **세마포어**를 사용하여 공유 메모리 접근을 동기화합니다.

### `shmget(2)` 시스템 호출

- 매개변수:
  - `size`: 메모리 세그먼트의 최소 크기(바이트)

### `shmat(2)` 시스템 호출

- `shmat`은 호출 프로세스의 주소 공간에 **지정된 공유 메모리 세그먼트를 부착**하고 `shmid`의 `shm_nattch` 값을 증가시킵니다.
- 매개변수:
  - `addr`:
    - `addr`가 0이면 커널이 선택한 첫 번째 사용 가능한 주소에 세그먼트를 부착합니다(권장 방법).
    - `addr`이 0이 아니고 `SHM_RND`가 지정되지 않은 경우 `addr`에 지정된 주소에 세그먼트를 부착합니다.
    - `addr`이 0이 아니고 `SHM_RND`가 지정된 경우 `(addr - (addr % SHMLBA))`에 세그먼트를 부착합니다.

### `shmdt(2)` 시스템 호출

- **`addr` 매개변수**는 이전에 `shmat` 호출로 반환된 값입니다. 호출이 성공하면, `shmdt`는 해당 `shmid_ds` 구조체의 **`shm_nattch` 카운터를 감소**시킵니다.

### `shmctl(2)` 시스템 호출

- **`cmd` 매개변수**는 `shmid`로 지정된 세그먼트에 대해 수행할 다섯 가지 명령 중 하나를 지정합니다.