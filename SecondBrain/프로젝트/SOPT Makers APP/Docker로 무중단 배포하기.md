## 배경
제가 진행하고 있는 프로젝트인 SOPT Makers에서는 여러 팀이 SOPT라는 동아리의 즐거운 활동을 위해서 여러 서비스를 제공해주는 단체에요.
SOPT Makers에는 공식 홈페이지 팀, Playground 팀, Crew 팀, Platform 팀, 앱 팀의 5가지 팀이 각자의 역할을 하며 개발을 해요.
하지만 이런 구성이다 보니 여러 EC2를 사용하는 상황이었고, AWS에서 IPv4의 유료화 등 점차 가격이 오름에 따라 EC2의 가격이 부담되는 상황이 발생했어요.

따라서 과거에는 각 팀마다 prod, dev EC2를 따로 두었지만, AWS 비용을 줄이기 위해서 dev는 한 개의 EC2로 통합하고, 각자의 환경은 docker를 통해 환경을 분리했습니다.
그 과정에서 dev 환경을 docker 환경으로 변경하고, 추가적으로 Docker를 이용해 무중단 배포를 진행할 수 있도록 변경하였습니다.

## EC2 하나로 하는 무중단 배포
보통 **무중단 배포**는 서버를 두 대 이상 사용하고, 로드밸런서를 이용해서 무중단 배포를 진행합니다.
그 이유는, 새로운 버전을 배포하려면 
1. 새로운 버전을 배포한다. 
2. 새로운 버전이 잘 돌아가는 것을 확인한다.
3. 요청이 새로운 버전으로 돌아가게 변경한다
의 순서를 사용합니다.

하지만, 서버 한 대를 사용한다면 이전 버전과 새로운 버전은 같은 포트를 사용하기 때문에 새로운 버전 배포 시 잘 돌아가고 있던 이전 버전의 포트와 충돌이 발생하기 때문입니다.

따라서 서버를 두 개 사용하고, EC2_1이 요청을 받으며 잘 실행 중이라면,
1. EC2_2에 새로운 버전을 배포한다
2. EC2_2에 새로운 버전이 잘 돌아가는 것을 확인한다.
3. 로드밸런서가 요청이 EC2_2로 돌아가도록 변경한다
이렇게 한다면 EC2_1과 EC2_2는 서로 다른 컴퓨터이기 때문에 다른 포트를 사용하고, 무중단 배포가 잘 돌아가게 됩니다.

그렇다면, 서버 한 대로는 어떻게 무중단 배포를 진행할 수 있을까요?
바로 이전 버전과 새로운 버전을 다른 컴퓨터에서 같은 포트를 사용하는 것이 아닌, 같은 컴퓨터에서 다른 포트를 사용하도록 하는 것입니다. (8080, 8081)
(ec2 - 로드밸런서)의 관계를 (ec2 내부에서 nginx - docker로 변경하는 사진)

따라서 github action을 이용해 아래 과정을 진행했습니다.
1. docker image 빌드 & ECR에 push
2. docker-compose.yml과 script 폴더 ec2에 복사
3. ec2에서 script 폴더 내의 deploy script 실행

deploy shell script에서는 아래 과정을 진행합니다.
1. 실행하는 컨테이너의 포트를 확인한다.
2. 사용가능한 포트를 확인한다.
3. 사용 가능한 포트를 실행한다
4. 새로운 버전을 실행한 컨테이너에 대해서 health check를 진행한다.
5. nginx reload를 진행하여 구버전의 포트를 바라보던 nginx를 새로운 버전의 포트를 바라보도록 변경한다.
6. 구버전의 컨테이너를 제거한다.

이렇게 하면 배포 시의 다운 타임이 기존 8초에서 0.03초로 개선된다.
물론 좋은 개선이지만, 당연히 다운 타임이 없을 것으로 예측되던 상황에서 0.03초라는 작은 다운타임이 발생했습니다.
이 다운 타임은 왜 발생했을까요?

