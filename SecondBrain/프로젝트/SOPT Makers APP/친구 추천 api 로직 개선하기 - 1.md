이번에 SOPT Makers App팀 4기 3차 스프린트에서 익명 콕 찌르기 기능을 도입하면서 친구 추천 api 개선을 맡게 되었습니다. 
그동안은 친구 추천 로직이 같은 기수의 친구만을 추천했지만, 익명 기능이 추가되며 좀 더 여러 친구를 추천한다면 유저들이 콕 찌르기 기능을 더 잘 사용할 것이라는 기획으로 인해 친구 추천에 같은 MBTI, 같은 학교 추천이 들어가게 되었습니다.

SOPT에서는 목적 조직 형식으로 팀을 운영하고 있습니다. 저는 App팀이지만, 유저의 정보들은 playground팀에서 관리하고 있고 이 정보에 접근하기 위해서는 Playground 팀의 internal api가 필요해요

친구 추천 로직 개발 초기에는 기존 방식이었던 playground 팀의 internal api를 통해 멤버의 프로필을 조건에 맞는 유저로만 필터링 해 모두 가져와서 기존의 친구 관계를 맺는 유저를 제외한 후 랜덤으로 추천 로직을 돌렸습니다. 따라서 기존 방식과 비슷하게 같은 MBTI 별 추천, 같은 학교 추천도 같은 로직을 사용하도록 개발하였는데요

dev에서는 잘 돌아가던 이 녀석... prod 서버에 들어가게 되니 api 호출 속도가 현저히 느려졌습니다.
테스트 코드도 작성하고, postman으로 테스트도 해봤지만 dev에서의 테스트만으로는 prod의 모든 문제를 잡을 수 없다는 것을 느꼈어요.

dev의 playground api에서 반환되던 유저 정보의 양과 prod의 api에서 반환되는 유저 정보의 양이 다르다보니 발생한 문제인데요, 제 api의 속도만 고려했지 외부 api에서 여러 정보를 요구하다보니 외부 api에서 발생하는 부하는 고려하지 못했습니다. 따라서 prod 서버의 친구 추천 로직의 응답 시간이 많이 길어지고, 심지어는 가끔 timeout이 발생하여 기능이 작동하지 않기도 했어요.

기능이 작동하지 않는 이유는 다음과 같았습니다.
- 친구 추천 api를 한 번 돌릴 때 마다playground api의 추천된 친구 반환 정보가 많아 playground 서버가 부하를 감당하기 어려움 (게다가 친구 추천 api는 자신이 원하는 친구를 찾기 위해 재 호출이 잦은 api예요)

따라서 해결 방식으로 세 가지 정도를 생각해보았습니다
- playground에게 조건에 맞는 필터링 후 유저의 모든 정보를 반환하는 것이 아닌, 유저의 id만 제공하는 internal api를 요청한다.
	- playground api를 이용해 필터링된 유저의 id만을 가져온 후 App 팀 내부에서의 비즈니스 로직을 돌려서 추천 대상인 유저의 id를 랜덤으로 2명씩 뽑는다.
	- 추천된 친구의 id를 playground에서 id를 통해 프로필을 가져오는 api를 이용해 추천된 친구만 프로필을 가져오도록 한다.
- playground의 멤버 프로필 조회 api를 친구 추천 로직을 호출할 때마다 호출하지 않도록 response를 캐싱하여 사용한다.
- playground의 멤버 프로필 조회 api에서 페이지네이션을 사용하여 playground 측의 서버 부하를 줄인다
	- 이렇게 사용을 해도 playground의 서버 부하를 줄일 수 있지만, 페이지네이션을 이용해 app 서버에서의 비즈니스 로직을 돌려 제외해야할 유저를 제외하였을 때, 목표한 만큼의 유저를 추천하지 못하면 다시 api를 호출하여 목표한 만큼의 유저를 추천할 수 있도록 해야해 오히려 api 호출량이 증가할 수 있을 것으로 판단되었습니다.
	  또한 페이지네이션을 이용하여 추천 로직을 이용하게 되면 친구 추천이 그룹화되어 같은 그룹끼리만의 추천이 될 수 있을 가능성이 있어 이는 유저 경험에 좋지 않은 추천 로직이라고 판단되었습니다.

따라서 성능 개선을 위해 선택할 수 있는 선택지는 두 가지 정도가 있었습니다.
하지만, 그때 당시 app팀의 아키텍쳐에는 캐싱 관련한 아키텍쳐가 구현되어 있지 않았고, 친구 추천 로직 개선의 핫픽스가 빠르게 필요하였기 때문에 캐싱은 추후에 성능 개선에 유의미한 결과를 낼 수 있을지에 대해 검증을 해보도록 하고, playground 측과 협의하여 유저의 id만을 제공하는 internal api를 요청드리고 수정하게 되었습니다.

그 결과, 친구 추천 로직이 개선되어 정상적으로 응답이 오도록 변경되었습니다.

이 일을 겪으면서 많은 것들을 배운 것 같아요
- 다른 팀에게 요청하는 것을 두려워하지 말자
	- 사실 멤버 프로필 조회 api 같은 경우에는 이미 기존 친구 추천 api에서 사용하고 있는 playground api이기도 했고, 새로운 api를 위해 비슷한 api를 또 요청드리는 것이 우리 피쳐를 위해 다른 팀까지 끌어들이는 것 같아 요청드리기가 조금 꺼려졌던 것 같아요.
	  
	  하지만 다시 생각해봤을 때, 저희는 SOPT Makers 내부에서는 다른 팀일지는 몰라도  SOPT의 서비스를 사용하는 유저의 연결과 편리함이라는 공동의 목표를 가지고 있는 같은 SOPT Makers 팀이었어요. 
	  
	  따라서 다른 팀에게 성능 개선을 위해 요청드릴 때는 타당한 근거만 그 팀에게 납득시켜드릴 수 있다면 하나의 목표를 가진 팀이기 때문에 그 팀도 흔쾌히 받아줄 수 있을거에요. (그러기 위해서는 타당한 근거를 납득시킬 수 있는 자료를 제공하는 능력도 필요하겠죠!)
- dev에서 성공한다고 prod에서 성공하는 것은 아니다!
	- dev에서 테스트를 많이 해봤다고 생각했는데 prod에서의 정보량 때문에 prod api가 작동하지 않을 수도 있다는 사실을 간과했어요. 친구 추천 로직에서 돌아가는 유저의 수는 한정적이니까 괜찮을 것이라는 안일한 생각 때문일거에요. 그래서 dev에서도 제대로 된 성능 테스트를 통해 prod에 코드를 올려도 괜찮을 지에 대해서 잘 확인해봐야 해요.

일단 prod에서 정상적으로 기능이 작동할 수 있도록 변경은 했지만, 친구 추천 로직은 유저가 뷰에서 한 번 호출하는 것이 아니라 원하는 친구를 찾기 위해 여러번 리프레시하는 동작이 잦은 api에요. 그만큼 자주 호출하는 api이고 그로 인해 동작하는 것에 만족하는 것이 아니라 한 번 더 개선해보고자 노력해봤어요.

그건 다음 포스팅에서..