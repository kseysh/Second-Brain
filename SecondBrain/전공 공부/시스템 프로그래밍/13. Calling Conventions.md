## Stack Frame
메모리 내의 스택(일종의 메모리 영역)에서 함수 호출과 관련된 정보를 저장하는 데이터 구조
stack Frame은 
매개변수
지역 변수
리턴 포인터를 저장할 수 있다.
임시저장공간으로도 활용가능하다

callee returns before caller does 
callee : 함수 안의 함수
caller : 함수를 부른 함수
#### 관리
공간은 함수 안으로 들어갔을 때 할당된다.
call 함수에 의해 push를 수행한다.
return될 때 Deallocated를 수행한다.
ret 함수에 의해 pop을 수행한다.
### Ex 1
![[Pasted image 20231103123228.png]]

![[Pasted image 20231103123310.png]]

![[Pasted image 20231103123350.png]]
.
.
.
![[Pasted image 20231103123413.png]]
여기서 부터는 return을 해준다.
![[Pasted image 20231103123436.png]]
.
.
.
![[Pasted image 20231103123526.png]]

### Ex 2
![[Pasted image 20231103124051.png]]
첫 번째 매개변수는 rdi에, 두 번째 매개변수는 rsi에, return value는 rax에 넣는다.

#### Calling incr
![[Pasted image 20231103124446.png]]
`subq $16, %rsp`를 통해 `%rsp`를 16 감소시킨다.

`movq $15213 8(%rsp)`를 통해 `%rsp`+8에 `$15213`을 저장한다.

![[Pasted image 20231103125058.png]]
`%rsi`에 3000을 저장한다.

`leaq 8(%rsp), %rdi`를 통해 주소값을 `%rdi`에 넣어준다.

![[Pasted image 20231103130122.png]]

![[Pasted image 20231103130228.png]]

![[Pasted image 20231103130421.png]]

## Register Saving Conventions
caller와 callee가 같은 메모리 주소를 사용해버리면 안되니까 둘 사이의 약속이 필요하다.
### Caller Saved
Caller가 Stack에(자신의 frame에) 메모리를 빼놓는 것
### Callee Saved
Callee가 메모리를 사용하기 전에 빼놓고, return 때 돌려주는 것.

![[Pasted image 20231103130909.png]]
### `%rax`
return value이므로 caller가 save해야한다.
callee가 바꿀 것이 명백하므로 caller-saved로 한다.
### `%rdi...%r9`
Argument를 전달할 때 사용하는 레지스터이므로 caller가 save해야한다.
### `%r10, %r11`
딱히 이유는 없지만 caller가 save한다.

나머지는 다 callee-saved이다.
![[Pasted image 20231103131601.png]]
### `%rbx, %r12, %r13, %r14`
나머지로 딱히 이유는 없고, callee가 save한다.
### `%rbp`
호출된 순간 %rbp에는 이전 스택 프레임의 base가 적혀있다.
### `%rsp`
항상 stack의 top이 저장되어 있는데, 
호출된 함수와 호출자 함수 간에 스택 프레임을 올바르게 관리하기 위해 스택 포인터의 값이 유지되어야 하기 때문

